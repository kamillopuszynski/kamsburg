<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KamsBurg – Szczegóły rezerwacji</title>
  <style>
    body { font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; background:#f5f5f5; color:#333; }
    .container { max-width:700px; margin:40px auto; background:#fff; padding:24px; border-radius:10px; box-shadow:0 4px 14px rgba(0,0,0,.08); }
    h1 { margin:0 0 16px; font-weight:500; }
    .row { margin:10px 0; }
    .label { color:#666; font-size:.95rem; }
    .val { font-size:1.05rem; font-weight:600; }
    .status { display:inline-block; padding:6px 10px; border-radius:999px; font-size:.9rem; }
    .active { background:#e8f5e9; color:#2e7d32; }
    .cancelled { background:#ffebee; color:#c62828; }
    .actions { margin-top:18px; display:flex; gap:12px; }
    button { padding:.7rem 1.2rem; border:none; border-radius:6px; cursor:pointer; }
    .danger { background:#e53935; color:#fff; }
    .secondary { background:#eceff1; }
    #msg { margin-top:14px; color:#2e7d32; display:none; }
    #err { margin-top:14px; color:#c62828; display:none; }
    .codeBox { margin-top:10px; display:none; }
    input[type="text"] { padding:.6rem; border:2px solid #ddd; border-radius:6px; width:160px; letter-spacing:3px; text-align:center; font-weight:600; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Twoja rezerwacja</h1>
    <div class="row"><span class="label">Status:</span> <span id="status" class="status">…</span></div>
    <div class="row"><span class="label">Imię i nazwisko:</span> <span class="val" id="name">…</span></div>
    <div class="row"><span class="label">Email:</span> <span class="val" id="email">…</span></div>
    <div class="row"><span class="label">Telefon:</span> <span class="val" id="phone">…</span></div>
    <div class="row"><span class="label">Data i godzina:</span> <span class="val" id="when">…</span></div>
    <div class="row"><span class="label">Liczba osób / stolik:</span> <span class="val" id="table">…</span></div>

    <div class="actions">
      <button class="danger" id="cancelBtn">Anuluj rezerwację</button>
      <button class="secondary" onclick="location.href='index.html'">Nowa rezerwacja</button>
    </div>

    <div class="codeBox" id="codeBox">
      <p>Wpisz 6-cyfrowy kod potwierdzenia anulowania (wysłany w mailu):</p>
      <input type="text" id="code" maxlength="6" placeholder="______">
      <button id="confirmCancel">Potwierdź</button>
    </div>

    <div id="msg">Rezerwacja została anulowana.</div>
    <div id="err"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    // same Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAOIXtjM9PMFXa0YFZfiDpfXlq_5sKxjv8",
      authDomain: "systemrezerwacji-dbd7c.firebaseapp.com",
      databaseURL: "https://systemrezerwacji-dbd7c-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "systemrezerwacji-dbd7c",
      storageBucket: "systemrezerwacji-dbd7c.firebasestorage.app",
      messagingSenderId: "1018043438907",
      appId: "1:1018043438907:web:d9b9e9190bd189dc2b491e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // read params
    const params = new URLSearchParams(location.search);
    const id = params.get("id");
    const date = params.get("date");

    const ui = {
      status: document.getElementById('status'),
      name: document.getElementById('name'),
      email: document.getElementById('email'),
      phone: document.getElementById('phone'),
      when: document.getElementById('when'),
      table: document.getElementById('table'),
      cancelBtn: document.getElementById('cancelBtn'),
      codeBox: document.getElementById('codeBox'),
      code: document.getElementById('code'),
      confirmCancel: document.getElementById('confirmCancel'),
      msg: document.getElementById('msg'),
      err: document.getElementById('err'),
    };

    if (!id || !date) {
      ui.err.textContent = "Brak identyfikatora rezerwacji.";
      ui.err.style.display = "block";
      ui.cancelBtn.disabled = true;
    } else {
      const rref = ref(db, `reservations/${date}/${id}`);
      const snap = await get(rref);
      if (!snap.exists()) {
        ui.err.textContent = "Nie znaleziono rezerwacji.";
        ui.err.style.display = "block";
        ui.cancelBtn.disabled = true;
      } else {
        const r = snap.val();

        render(r);

        ui.cancelBtn.addEventListener('click', ()=>{
          ui.codeBox.style.display = 'block';
          ui.err.style.display = 'none';
          ui.msg.style.display = 'none';
        });

        ui.confirmCancel.addEventListener('click', async ()=>{
          const code = (ui.code.value || '').trim();
          if (code.length !== 6) {
            ui.err.textContent = "Kod musi mieć 6 cyfr.";
            ui.err.style.display = "block";
            return;
          }
          if (code !== r.cancelCode) {
            ui.err.textContent = "Nieprawidłowy kod.";
            ui.err.style.display = "block";
            return;
          }
          try {
            await update(rref, { status: "cancelled", cancelledAt: new Date().toISOString() });
            ui.msg.style.display = "block";
            ui.err.style.display = "none";
            const updated = { ...r, status: "cancelled" };
            render(updated);
          } catch (e) {
            ui.err.textContent = "Nie udało się anulować. Spróbuj ponownie.";
            ui.err.style.display = "block";
          }
        });
      }
    }

    function render(r) {
      ui.status.textContent = r.status === 'cancelled' ? 'Anulowana' : 'Aktywna';
      ui.status.className = 'status ' + (r.status === 'cancelled' ? 'cancelled' : 'active');
      ui.name.textContent = `${r.firstName || ''} ${r.lastName || ''}`.trim();
      ui.email.textContent = r.email || '-';
      ui.phone.textContent = r.phone || '-';
      ui.when.textContent = `${r.date} ${String(r.hour).padStart(2,'0')}:00`;
      ui.table.textContent = `${r.people}-os. / stolik nr ${r.tableNumber} (${r.tableCategory}-os.)`;
      ui.cancelBtn.disabled = r.status === 'cancelled';
    }
  </script>
</body>
</html>
