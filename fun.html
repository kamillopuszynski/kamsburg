<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KamsBurg — System Rezerwacji Stolików</title>
  <meta name="color-scheme" content="light dark">
  <style>
    /* ===================== THEME & RESET ===================== */
    :root{
      --bg: #0b1220;
      --bg-soft:#0f172a;
      --card:#0b1220cc;
      --text:#e6eefc;
      --muted:#a9b8d9;
      --brand:#5aa9ff;
      --brand-2:#7c4dff;
      --ok:#22c55e;
      --err:#ef4444;
      --warn:#f59e0b;
      --border:#23314f;
      --ring: 0 0 0 .2rem rgba(90,169,255,.35);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 14px;
    }
    @media (prefers-color-scheme:light){
      :root{
        --bg:#f5f7fb;
        --bg-soft:#eef3fb;
        --card:#ffffffd9;
        --text:#1d2433;
        --muted:#5b6b88;
        --brand:#1e88e5;
        --brand-2:#6a5acd;
        --ok:#16a34a;
        --err:#dc2626;
        --warn:#d97706;
        --border:#d8e0f0;
        --shadow: 0 10px 30px rgba(0,0,0,.08);
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font:16px/1.55 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(124,77,255,.24), transparent 60%),
        radial-gradient(1000px 700px at 100% 0%, rgba(30,136,229,.22), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg));
      background-attachment: fixed;
    }
    a{color:inherit}

    /* ===================== LAYOUT ===================== */
    .container{
      max-width: 980px;
      margin: 0 auto;
      padding: 24px;
    }
    header.header{
      position: sticky; top: 0; z-index: 50;
      backdrop-filter: saturate(1.2) blur(12px);
      background: linear-gradient(180deg, rgba(6,12,24,.65), rgba(6,12,24,.25));
      border-bottom:1px solid var(--border);
    }
    .hero{
      display:flex; align-items:center; gap:18px; padding:18px 0;
    }
    .logo{
      width:48px; height:48px; border-radius:12px;
      display:grid; place-items:center;
      background: conic-gradient(from 210deg, var(--brand), var(--brand-2));
      color:#fff; font-weight:800; letter-spacing:.5px; text-shadow:0 2px 8px rgba(0,0,0,.25);
      box-shadow: var(--shadow);
    }
    .title-wrap h1{margin:0; font-size: clamp(22px, 3vw, 30px); font-weight:800; letter-spacing:.3px}
    .title-wrap p{margin:2px 0 0; color:var(--muted); font-size:.95rem}

    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 22px;
      margin-top: 22px;
    }
    @media (max-width:900px){ .grid{ grid-template-columns:1fr } }

    /* ===================== CARDS ===================== */
    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: clip;
    }
    .card .head{
      display:flex; align-items:center; gap:10px;
      padding:16px 18px; border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.04), transparent);
    }
    .head .ico{width:22px; height:22px; opacity:.9}
    .card .body{padding:18px}

    /* ===================== FORM ===================== */
    .form-row{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }
    @media (max-width:640px){ .form-row{ grid-template-columns:1fr } }
    .form-group{ display:flex; flex-direction:column; gap:8px; }
    label{ font-weight:600; font-size:.95rem; color:var(--muted) }
    .field{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1.5px solid var(--border);
      border-radius: 12px;
      padding: 12px 14px;
      color: var(--text);
      outline: none;
      transition: border-color .2s ease, box-shadow .2s ease, transform .04s ease;
    }
    .field:focus{
      border-color: var(--brand);
      box-shadow: var(--ring);
    }
    select.field{ appearance:none; background-image:
      linear-gradient(45deg, transparent 50%, var(--muted) 50%),
      linear-gradient(135deg, var(--muted) 50%, transparent 50%);
      background-position: calc(100% - 18px) calc(1em - 2px), calc(100% - 14px) calc(1em - 2px);
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
    }
    .help{ font-size:.85rem; color:var(--muted) }

    /* ===================== TIME SLOTS ===================== */
    .slots{
      display:grid; grid-template-columns: repeat(auto-fill, minmax(90px,1fr)); gap:10px;
    }
    .slot{
      user-select:none;
      border:1.5px solid var(--border);
      border-radius: 12px;
      padding:10px 8px;
      text-align:center;
      cursor:pointer;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.015));
      transition: transform .06s ease, border-color .2s ease, background .2s ease, opacity .2s ease;
    }
    .slot:hover{ border-color: var(--brand) }
    .slot:active{ transform: translateY(1px) }
    .slot.selected{
      background: linear-gradient(180deg, rgba(90,169,255,.28), rgba(90,169,255,.18));
      border-color: var(--brand);
      box-shadow: var(--ring);
    }
    .slot.unavailable{
      opacity:.5; cursor:not-allowed; filter: grayscale(.2);
    }
    .slot.suggested{
      border-color: var(--warn);
      background: linear-gradient(180deg, rgba(245,158,11,.18), rgba(245,158,11,.08));
    }

    /* ===================== BUTTONS ===================== */
    .btn{
      width:100%;
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      border:none; cursor:pointer; font-weight:700; letter-spacing:.3px;
      border-radius:12px; padding:12px 16px; margin-top:10px;
      color:white;
      background-image: linear-gradient(135deg, var(--brand), var(--brand-2));
      box-shadow: var(--shadow);
      transition: filter .2s ease, transform .06s ease, box-shadow .2s ease, opacity .2s ease;
    }
    .btn:hover{ filter:saturate(1.1) brightness(1.02) }
    .btn:active{ transform: translateY(1px) }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; }
    .btn .spinner{
      width:16px;height:16px;border:2px solid rgba(255,255,255,.35);
      border-top-color:white;border-radius:50%; display:none; animation:spin .8s linear infinite;
    }
    .btn.loading .spinner{ display:inline-block }
    @keyframes spin{ to{ transform:rotate(360deg) } }

    /* ===================== STATUS GRID ===================== */
    .status-note{
      background: linear-gradient(180deg, rgba(90,169,255,.12), rgba(90,169,255,.06));
      border:1px dashed var(--brand);
      color: var(--text);
      padding:12px 14px; border-radius:12px; margin-bottom:12px;
      font-weight:600;
    }
    .table-grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(160px,1fr)); gap:12px; }
    .table-card{
      border:1.5px solid var(--border); border-radius:12px; padding:12px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    }
    .table-card .n{ font-weight:800; font-size:1.05rem }
    .table-card .i{ color:var(--muted); font-size:.9rem }
    .table-card.ok{ outline:1px solid rgba(34,197,94,.35); background: linear-gradient(180deg, rgba(34,197,94,.14), rgba(34,197,94,.06)); }
    .table-card.no{ outline:1px solid rgba(239,68,68,.35); background: linear-gradient(180deg, rgba(239,68,68,.12), rgba(239,68,68,.05)); }

    /* ===================== TOASTS & BANNERS ===================== */
    .toast{
      position: fixed; right: 18px; bottom: 18px; z-index: 9999;
      max-width: 420px; transform: translateY(20px); opacity:0;
      transition: transform .25s ease, opacity .25s ease;
    }
    .toast.show{ transform: translateY(0); opacity:1 }
    .toast .msg{
      padding:14px 16px; margin-top:10px; border-radius:12px; border:1px solid var(--border);
      background: var(--card); box-shadow: var(--shadow);
    }
    .msg.success{ border-color: rgba(34,197,94,.5); }
    .msg.error{ border-color: rgba(239,68,68,.55); }
    .msg.info{ border-color: rgba(90,169,255,.55); }
    .msg .title{ font-weight:800; margin-bottom:4px }
    .msg .desc{ color:var(--muted) }

    .netbar{
      position: fixed; top:0; left:0; right:0; z-index:100;
      display:none; place-items:center;
      padding:10px 14px; font-weight:700; letter-spacing:.3px;
      background: linear-gradient(135deg, #f97316, #ef4444); color:#fff;
      box-shadow: var(--shadow);
    }
    .netbar.show{ display:grid }

    /* ===================== UTILS ===================== */
    .sr-only{ position:absolute !important; height:1px;width:1px; overflow:hidden; clip:rect(1px,1px,1px,1px) }

    .toolbar{
      display:flex; align-items:center; justify-content:space-between;
      padding:8px 0 0;
    }
    .toolbtn{
      display:inline-flex; align-items:center; gap:8px; font-weight:700; font-size:.9rem;
      color: var(--muted); cursor:pointer; user-select:none;
    }
    .toolbtn input{ display:none }
    .switch{
      width:44px; height:26px; border-radius:20px; position:relative;
      background: #2a3650; border:1px solid var(--border); transition:background .2s ease;
    }
    .switch::after{
      content:""; position:absolute; top:3px; left:3px; width:20px; height:20px; border-radius:50%;
      background:#fff; transition:left .18s ease;
      box-shadow: 0 2px 6px rgba(0,0,0,.35);
    }
    .toolbtn input:checked + .switch{ background:#e8eefc }
    .toolbtn input:checked + .switch::after{ left:21px }

    .placeholder{
      text-align:center; color:var(--muted); padding:24px; font-style:italic;
      border:1px dashed var(--border); border-radius:12px; background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
    }

    /* Reduced motion respect */
    @media (prefers-reduced-motion:reduce){
      *{ animation:none !important; transition:none !important }
    }
  </style>
</head>
<body>
  <!-- Offline/online banner -->
  <div id="netbar" class="netbar" role="status" aria-live="polite">Brak połączenia — działasz offline. Zapis nastąpi po powrocie sieci.</div>

  <header class="header" role="banner">
    <div class="container hero" aria-label="Nagłówek strony">
      <div class="logo" aria-hidden="true">KB</div>
      <div class="title-wrap">
        <h1>KamsBurg — Rezerwacje</h1>
        <p>Wybierz termin, wpisz dane i potwierdź. Czas trwania rezerwacji: <strong>2h</strong>. Godziny otwarcia: <strong>10:00–22:00</strong>.</p>
      </div>
    </div>
  </header>

  <main class="container" id="main" role="main">
    <div class="toolbar" aria-label="Ustawienia interfejsu">
      <div class="toolbtn" id="clearDraftBtn" role="button" tabindex="0">
        <!-- broom -->
        <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M16 11l7-7l-2-2l-7 7l2 2M2 22h6l9-9l-6-6L2 16v6Zm3.5-4.5L8 20H4v-4l1.5 1.5Z"/></svg>
        Wyczyść szkic
      </div>
      <label class="toolbtn" title="Tryb jasny/ciemny">
        <input id="themeToggle" type="checkbox" aria-label="Przełącz motyw">
        <span class="switch"></span>
        Motyw
      </label>
    </div>

    <section class="grid" aria-label="Panel rezerwacji i status stolików">
      <!-- FORM CARD -->
      <article class="card" aria-labelledby="formTitle">
        <div class="head">
          <svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M21 8V7l-3 2l-3-2l-3 2l-3-2l-3 2l-3-2v13q0 .425.288.713T3 21h14q.425 0 .713-.288T18 20V9l3-1Zm-7 5h-4v-2h4v2Z"/></svg>
          <h2 id="formTitle" style="margin:0">Dokonaj rezerwacji</h2>
        </div>
        <div class="body">
          <form id="reservationForm" novalidate>
            <div class="form-row">
              <div class="form-group">
                <label for="firstName">Imię</label>
                <input class="field" type="text" id="firstName" autocomplete="given-name" required aria-required="true" />
                <div class="help" id="firstNameHelp">Wpisz imię osoby rezerwującej.</div>
              </div>
              <div class="form-group">
                <label for="lastName">Nazwisko</label>
                <input class="field" type="text" id="lastName" autocomplete="family-name" required aria-required="true" />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="phone">Telefon</label>
                <input class="field" type="tel" id="phone" inputmode="tel" placeholder="+48 600 000 000" required aria-required="true"/>
                <div class="help">Automatycznie formatujemy numer (możesz wkleić bez spacji).</div>
              </div>
              <div class="form-group">
                <label for="email">Email</label>
                <input class="field" type="email" id="email" inputmode="email" autocomplete="email" required aria-required="true"/>
              </div>
            </div>

            <div class="form-group">
              <label for="people">Liczba osób</label>
              <select id="people" class="field" required aria-required="true">
                <option value="">— wybierz —</option>
                <option value="2">2 osoby</option>
                <option value="4">4 osoby</option>
                <option value="6">6 osób</option>
                <option value="8">8 osób</option>
              </select>
              <div class="help">System dobierze stolik dokładnie dla wybranej kategorii (bez „upgrade” do większego).</div>
            </div>

            <div class="form-group">
              <label for="date">Data</label>
              <input class="field" type="date" id="date" required aria-required="true"/>
            </div>

            <div class="form-group">
              <label>Godzina</label>
              <div id="timeSlots" class="slots" role="listbox" aria-label="Dostępne godziny"></div>
              <div class="help">Kliknij godzinę lub użyj klawiszy strzałek, by nawigować po slotach (Enter = wybór).</div>
            </div>

            <button type="submit" id="submitBtn" class="btn" disabled aria-disabled="true">
              <span class="spinner" aria-hidden="true"></span>
              <span>✅ Zarezerwuj stolik</span>
            </button>
          </form>
        </div>
      </article>

      <!-- STATUS CARD -->
      <aside class="card" id="tableStatusSection" style="display:none" aria-labelledby="statusTitle">
        <div class="head">
          <svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M3 20V8l9-5l9 5v12H3Zm9-9l7-3.89L12 3L5 7.11L12 11ZM5 18h14V9l-7 3.89L5 9v9Z"/></svg>
          <h2 id="statusTitle" style="margin:0">Status stolików</h2>
        </div>
        <div class="body">
          <div id="timeInfo" class="status-note" aria-live="polite"></div>
          <div id="tableGrid" class="table-grid" role="grid"></div>
        </div>
      </aside>

      <aside class="card" id="tablePlaceholder">
        <div class="head">
          <svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M2 22V2h11l1 1h8v13h-2V5h-6.17l-1-1H4v16h6v2H2Zm14-2v-3h-3v-2h3v-3h2v3h3v2h-3v3h-2Z"/></svg>
          <h2 style="margin:0">Dostępność</h2>
        </div>
        <div class="body">
          <div class="placeholder">Wybierz godzinę, aby zobaczyć dostępność stolików.</div>
        </div>
      </aside>
    </section>
  </main>

  <!-- Toasts -->
  <div id="toast" class="toast" aria-live="polite" aria-atomic="true"></div>

  <!-- Confetti (canvas) -->
  <canvas id="confetti" class="sr-only" aria-hidden="true"></canvas>

  <!-- =============== Firebase + App Logic (no DB schema changes) =============== -->
  <script type="module">
    /************ Firebase imports (CDN) ************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, onValue, push, set } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    /************ firebaseConfig (unchanged) ************/
    const firebaseConfig = {
      apiKey: "AIzaSyAOIXtjM9PMFXa0YFZfiDpfXlq_5sKxjv8",
      authDomain: "systemrezerwacji-dbd7c.firebaseapp.com",
      databaseURL: "https://systemrezerwacji-dbd7c-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "systemrezerwacji-dbd7c",
      storageBucket: "systemrezerwacji-dbd7c.firebasestorage.app",
      messagingSenderId: "1018043438907",
      appId: "1:1018043438907:web:d9b9e9190bd189dc2b491e",
      measurementId: "G-YXB460ZGR1"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    /************ App Config (unchanged core) ************/
    const TABLES = { 2:2, 4:2, 6:2, 8:2 };
    const OPENING_HOURS = { start:10, end:22 }; // slots: 10..21
    const RESERVATION_DURATION = 2;             // hours

    // State
    let selectedTime = null;
    let reservationsCache = []; // entries for current date
    let currentDate = null;

    // DOM
    const dateEl   = document.getElementById('date');
    const peopleEl = document.getElementById('people');
    const submitBtn= document.getElementById('submitBtn');
    const timeSlotsEl = document.getElementById('timeSlots');
    const toastEl = document.getElementById('toast');
    const netbar  = document.getElementById('netbar');

    // Min date = today
    dateEl.min = new Date().toISOString().split('T')[0];

    // Theme toggle persist
    const themeToggle = document.getElementById('themeToggle');
    const savedTheme = localStorage.getItem('kamsburg_theme');
    if(savedTheme){ themeToggle.checked = savedTheme==='light'; applyTheme(savedTheme) }
    themeToggle.addEventListener('change', ()=>{
      const mode = themeToggle.checked ? 'light' : 'dark';
      applyTheme(mode);
      localStorage.setItem('kamsburg_theme', mode);
    });
    function applyTheme(mode){
      document.documentElement.style.colorScheme = mode;
      // background already adapts via color-scheme + root palette
    }

    // Draft persistence (auto-save)
    const fields = ['firstName','lastName','phone','email','people','date'];
    const draftKey = 'kamsburg_draft_v1';
    const draft = JSON.parse(localStorage.getItem(draftKey) || '{}');
    for(const f of fields){
      const el = document.getElementById(f);
      if(draft[f]) el.value = draft[f];
      el.addEventListener('input', debounce(()=>{
        const data = {};
        for(const k of fields){ data[k] = document.getElementById(k).value }
        localStorage.setItem(draftKey, JSON.stringify(data));
        if(f==='people' || f==='date') { updateTimeSlots(); if(selectedTime!==null) showTableStatus(); }
      }, 120));
    }
    document.getElementById('clearDraftBtn').addEventListener('click', ()=>{
      localStorage.removeItem(draftKey);
      for(const f of fields){ const el = document.getElementById(f); if(el.tagName==='SELECT') el.selectedIndex=0; else el.value=''; }
      selectedTime=null; document.querySelectorAll('.slot').forEach(s=>s.classList.remove('selected','suggested'));
      submitBtn.disabled = true; submitBtn.setAttribute('aria-disabled','true');
      hideStatus();
      toast('Wyczyszczono szkic formularza.', 'info');
    });
    // keyboard accessibility for the "button-like" label
    document.getElementById('clearDraftBtn').addEventListener('keydown', (e)=>{
      if(e.key==='Enter' || e.key===' '){ e.preventDefault(); e.currentTarget.click(); }
    });

    // Phone mask (PL-first, but permissive): auto-format to +48 XXX XXX XXX if starts with 48/0048/+
    const phoneEl = document.getElementById('phone');
    phoneEl.addEventListener('input', ()=>{
      let v = phoneEl.value.replace(/\D+/g,'');
      if(v.startsWith('0048')) v=v.slice(4);
      if(v.startsWith('48')) v=v.slice(2);
      if(v.length<=9){
        const parts = [v.slice(0,3), v.slice(3,6), v.slice(6,9)].filter(Boolean);
        phoneEl.value = parts.join(' ').trim();
      }
      else { phoneEl.value = v; } // fallback, let user control
    }, {passive:true});

    // Email quick check
    const emailEl = document.getElementById('email');
    emailEl.addEventListener('blur', ()=>{
      const ok = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailEl.value.trim());
      if(!ok && emailEl.value.trim()!=='') toast('Sprawdź poprawność adresu e-mail.', 'info');
    });

    // Connectivity banner
    function onNetChange(){
      if(navigator.onLine){ netbar.classList.remove('show'); }
      else { netbar.classList.add('show'); }
    }
    window.addEventListener('online', onNetChange);
    window.addEventListener('offline', onNetChange);
    onNetChange();

    // Time slots generation
    generateTimeSlots();

    // Listen for date changes (RTDB listener per date)
    dateEl.addEventListener('change', ()=>{
      listenForDate(dateEl.value);
      updateTimeSlots();
      if(selectedTime!==null) showTableStatus();
    });

    // People changes update availability
    peopleEl.addEventListener('change', ()=>{
      updateTimeSlots();
      if(selectedTime!==null) showTableStatus();
    });

    // Form submit
    document.getElementById('reservationForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const firstName = document.getElementById('firstName').value.trim();
      const lastName  = document.getElementById('lastName').value.trim();
      const phone     = phoneEl.value.trim();
      const email     = emailEl.value.trim();
      const people    = parseInt(peopleEl.value || '0',10);
      const dateStr   = dateEl.value;
      const hour      = selectedTime;

      if(!firstName || !lastName || !phone || !email || !people || !dateStr || hour===null){
        toast('Uzupełnij wszystkie pola i wybierz godzinę.', 'error'); return;
      }
      if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){
        toast('Nieprawidłowy e-mail.', 'error'); return;
      }

      // final check against cache
      const availability = checkAvailability(people, dateStr, hour);
      submitBtn.classList.add('loading'); submitBtn.disabled=true; submitBtn.setAttribute('aria-disabled','true');

      try{
        if(availability.available){
          const payload = {
            firstName,lastName,phone,email,
            people, date:dateStr, hour,
            tableCategory: availability.tableCategory,
            tableNumber: availability.tableNumber,
            timestamp: new Date().toISOString()
          };
          const newRef = push(ref(db, `reservations/${dateStr}`));
          await set(newRef, payload);

          // UX goodies
          confetti();
          toast(
            `Rezerwacja potwierdzona! ${firstName} ${lastName}, stolik dla ${people} osób — nr ${availability.tableNumber} o ${hour}:00. Potwierdzenie wysłano na ${email}.`,
            'success'
          );

          // reset
          e.target.reset();
          localStorage.removeItem(draftKey);
          document.querySelectorAll('.slot').forEach(s=>s.classList.remove('selected','suggested'));
          selectedTime=null;
          submitBtn.disabled=true; submitBtn.setAttribute('aria-disabled','true');
          hideStatus();
          updateTimeSlots();
        }else{
          const nearest = findNearestAvailableTime(people, dateStr, hour);
          if(nearest!==null){
            highlightSuggestion(nearest);
            toast(`Wybrana godzina zajęta. Proponujemy ${nearest}:00.`, 'info');
          }else{
            toast('Brak dostępnych stolików w tym dniu.', 'error');
          }
        }
      }catch(err){
        console.error(err);
        toast('Błąd zapisu rezerwacji. Spróbuj ponownie.', 'error');
      }finally{
        submitBtn.classList.remove('loading');
        submitBtn.disabled = !canSubmit(); submitBtn.setAttribute('aria-disabled', submitBtn.disabled ? 'true':'false');
      }
    });

    // ================== Helpers & Core Logic (unchanged behavior) ==================
    function generateTimeSlots(){
      timeSlotsEl.innerHTML = '';
      for(let h=OPENING_HOURS.start; h<OPENING_HOURS.end; h++){
        const d = document.createElement('div');
        d.className = 'slot'; d.tabIndex = 0; // focusable
        d.textContent = `${h}:00`;
        d.dataset.hour = h;
        d.setAttribute('role','option');
        d.addEventListener('click', () => selectTimeSlot(d));
        d.addEventListener('keydown', (e)=>{
          if(e.key==='Enter' || e.key===' '){ e.preventDefault(); d.click(); }
          else if(e.key==='ArrowRight' || e.key==='ArrowDown'){ focusNextSlot(d) }
          else if(e.key==='ArrowLeft' || e.key==='ArrowUp'){ focusPrevSlot(d) }
        });
        timeSlotsEl.appendChild(d);
      }
    }
    function focusNextSlot(el){ const all=[...document.querySelectorAll('.slot')]; const i=all.indexOf(el); const n=all[i+1]||all[0]; n.focus(); }
    function focusPrevSlot(el){ const all=[...document.querySelectorAll('.slot')]; const i=all.indexOf(el); const p=all[i-1]||all[all.length-1]; p.focus(); }

    function selectTimeSlot(slot){
      if(slot.classList.contains('unavailable')) return;
      document.querySelectorAll('.slot').forEach(s=>s.classList.remove('selected','suggested'));
      slot.classList.add('selected');
      selectedTime = parseInt(slot.dataset.hour,10);
      submitBtn.disabled = !canSubmit(); submitBtn.setAttribute('aria-disabled', submitBtn.disabled ? 'true':'false');
      showTableStatus();
    }
    function canSubmit(){
      return !!dateEl.value && Number.isInteger(selectedTime) && !!peopleEl.value;
    }

    function listenForDate(dateStr){
      if(!dateStr) return;
      currentDate = dateStr;
      const dateRef = ref(db, `reservations/${dateStr}`);
      onValue(dateRef, (snap)=>{
        const val = snap.val();
        reservationsCache = val ? Object.entries(val).map(([id, r])=>({ id, ...r })) : [];
        updateTimeSlots();
        if(selectedTime !== null) showTableStatus();
      });
    }

    function checkAvailability(people, dateStr, hour){
      const reservationsForDate = reservationsCache.filter(r => r.date === dateStr);
      // choose exact table category (no upgrade)
      let tableCategory = 2;
      for (let size of [2,4,6,8]) {
        if (people <= size) { tableCategory = size; break; }
      }
      // occupied set (within 2h window)
      const occupied = new Set();
      reservationsForDate.forEach(r=>{
        const resHour = parseInt(r.hour,10);
        if (Math.abs(resHour - hour) < RESERVATION_DURATION) {
          occupied.add(`${r.tableCategory}_${r.tableNumber}`);
        }
      });
      for (let i=1; i<=TABLES[tableCategory]; i++){
        if(!occupied.has(`${tableCategory}_${i}`)){
          return { available:true, tableCategory, tableNumber:i };
        }
      }
      return { available:false };
    }

    function findNearestAvailableTime(people, dateStr, hour){
      for (let off=1; off < (OPENING_HOURS.end - OPENING_HOURS.start); off++){
        const after = hour + off;
        if(after < OPENING_HOURS.end){
          const a = checkAvailability(people, dateStr, after);
          if(a.available) return after;
        }
        const before = hour - off;
        if(before >= OPENING_HOURS.start){
          const b = checkAvailability(people, dateStr, before);
          if(b.available) return before;
        }
      }
      return null;
    }

    function updateTimeSlots(){
      const people = parseInt(peopleEl.value || '0',10);
      const dateStr = dateEl.value;

      document.querySelectorAll('.slot').forEach(slot=>{
        slot.classList.remove('unavailable','suggested');
        const hour = parseInt(slot.dataset.hour,10);

        // block past hours for "today"
        if(dateStr){
          const now = new Date();
          const today = now.toISOString().split('T')[0];
          if(dateStr === today && hour <= now.getHours()){
            slot.classList.add('unavailable'); return;
          }
        }
        if(!people || !dateStr) return;

        const availability = checkAvailability(people, dateStr, hour);
        if(!availability.available){
          slot.classList.add('unavailable');
        }
      });

      submitBtn.disabled = !canSubmit(); submitBtn.setAttribute('aria-disabled', submitBtn.disabled ? 'true':'false');
    }

    function showTableStatus(){
      const dateStr = dateEl.value;
      const section = document.getElementById('tableStatusSection');
      const placeholder = document.getElementById('tablePlaceholder');

      if(!dateStr || selectedTime===null){
        hideStatus(); return;
      }
      section.style.display = 'block';
      placeholder.style.display = 'none';

      document.getElementById('timeInfo').textContent =
        `Dostępność stolików — ${dateStr}, godz. ${selectedTime}:00`;

      const grid = document.getElementById('tableGrid');
      grid.innerHTML = '';

      const occupied = new Set();
      reservationsCache
        .filter(r => r.date === dateStr)
        .forEach(r=>{
          const resHour = parseInt(r.hour,10);
          if (Math.abs(resHour - selectedTime) < RESERVATION_DURATION) {
            occupied.add(`${r.tableCategory}_${r.tableNumber}`);
          }
        });

      Object.entries(TABLES).forEach(([size, count])=>{
        for(let i=1;i<=count;i++){
          const key = `${size}_${i}`;
          const isOcc = occupied.has(key);
          const card = document.createElement('div');
          card.className = `table-card ${isOcc?'no':'ok'}`;
          card.setAttribute('role','row');
          card.innerHTML = `
            <div class="n">Stolik ${i}</div>
            <div class="i">${size} osób</div>
            <div class="i">${isOcc ? 'Zajęty' : 'Wolny'}</div>
          `;
          grid.appendChild(card);
        }
      });
    }
    function hideStatus(){
      document.getElementById('tableStatusSection').style.display='none';
      document.getElementById('tablePlaceholder').style.display='block';
    }
    function highlightSuggestion(hour){
      document.querySelectorAll('.slot').forEach(s=>{
        s.classList.remove('suggested');
        if(parseInt(s.dataset.hour,10)===hour) s.classList.add('suggested');
      });
    }

    // Toasts
    let toastTimer=null;
    function toast(text, type='info'){
      const node = document.createElement('div');
      node.className = `msg ${type}`;
      node.innerHTML = `<div class="title">${type==='success'?'Sukces':type==='error'?'Błąd':'Informacja'}</div>
                        <div class="desc">${escapeHtml(text)}</div>`;
      toastEl.appendChild(node);
      toastEl.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>{
        toastEl.classList.remove('show');
        setTimeout(()=>toastEl.innerHTML='', 250);
      }, 5200);
    }
    function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m])) }

    // Debounce helper
    function debounce(fn, ms=150){
      let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms) }
    }

    // Confetti (very lightweight)
    function confetti(){
      const c = document.getElementById('confetti');
      c.classList.remove('sr-only');
      const ctx = c.getContext('2d');
      const W = c.width = window.innerWidth;
      const H = c.height= window.innerHeight;
      const N=120, parts=[];
      for(let i=0;i<N;i++){
        parts.push({
          x: Math.random()*W, y: -20-Math.random()*H*.5,
          r: 4+Math.random()*6,
          vx: -1+Math.random()*2, vy: 1+Math.random()*3,
          a: Math.random()*Math.PI, va: Math.random()*.2,
          col: `hsl(${Math.floor(Math.random()*360)},90%,60%)`
        });
      }
      let t=0; const stopAt=1200; // ~1.2s
      (function loop(){
        t+=16;
        ctx.clearRect(0,0,W,H);
        for(const p of parts){
          p.x+=p.vx; p.y+=p.vy; p.a+=p.va;
          ctx.save();
          ctx.translate(p.x,p.y); ctx.rotate(p.a);
          ctx.fillStyle=p.col;
          ctx.fillRect(-p.r*.6,-p.r*.2,p.r*1.2,p.r*.4);
          ctx.restore();
        }
        if(t<stopAt) requestAnimationFrame(loop);
        else { c.classList.add('sr-only'); ctx.clearRect(0,0,W,H); }
      })();
    }

    // Enable submit when all needed chosen
    function syncSubmitState(){
      const ok = canSubmit();
      submitBtn.disabled = !ok;
      submitBtn.setAttribute('aria-disabled', ok ? 'false':'true');
    }

    // Initial availability calc if draft prefilled
    if(dateEl.value){ listenForDate(dateEl.value) }
    updateTimeSlots();
    syncSubmitState();
  </script>
</body>
</html>
